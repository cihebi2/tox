# 方案：毒性预测的“概率 + 把握 + 证据 + 改造建议”

本文档面向你提出的点子：在毒性预测框架里**同时输出概率与把握（不确定性）**，并尽可能给出**可核验的证据**（最相关的实验/标注样本），同时提供一个**可执行的改造建议**（例如单点突变候选），最后把它做成一个 Web 产品形态。

---

## 1. 点子评估（为什么值得做）

### 价值

- **从“黑盒概率”升级为“概率 + 证据强度”**：用户不仅知道预测值，还能知道模型“有没有底气”。
- **更贴近真实决策流程**：科研/工程上更常见的是“模型建议 + 支撑样本/证据 + 可执行的下一步实验”，而不是只给一个分数。
- **老课题新方式**：毒性预测任务本身成熟，但把 *uncertainty + retrieval evidence + design suggestions* 打包成端到端工具，能明显增强可用性与可解释性。

### 风险与坑

- **不确定性≠正确性**：evidential 指标需要校准与验证（特别是 OOD 序列、分布偏移）。
- **证据检索的“相关性”容易被误解**：相似序列并不等于相同机制；必须清晰区分“相似样本证据”与“文献/数据库证据”。
- **改造建议的可行性**：单点突变可能破坏结构/活性（尤其是富含 Cys 的毒肽骨架），建议必须加约束或交由用户选择约束集。

---

## 2. 实现路线（已做的原型）

当前仓库实现了一个可运行的最小闭环（sequence-only baseline，用 ToxGIN 的序列+label 数据训练）：

1) **Evidential 毒性模型**（Dirichlet 输出）
   - 输出 `p(toxic)` + `uncertainty(K/sum(alpha))` + `total_evidence(sum(alpha)-K)`
2) **证据检索**
   - 用 char n-gram TF-IDF 在训练集中找 TopK 相似序列，并展示其 label（作为“有标注/实验结果的证据样本”）
3) **改造建议**
   - 生成单点突变候选，批量预测并按“更低毒性概率 + 更高把握”排序（优先从“最近的非毒相似序列”提取差异位点）
4) **Web 展示**
   - 输入序列 → 输出预测/把握/证据/建议

对应代码：

- 训练：`scripts/train_evi_tox.py`
- Web：`scripts/serve.py` + `webapp/app.py`
- 核心模块：`toxapp/`

---

## 3. 面向 ToxGIN 的“正确改造方式”（建议下一步做）

你真正想要的应该是：**把 evidential head 接到你现有的 ToxGIN（结构+序列）上**，而不是只做序列 baseline。

改造核心：

1) **分类头输出从 1 维 Sigmoid 改为 2 维 Dirichlet 参数**
   - `logits: [B,2]`
   - `alpha = softplus(logits) + 1`
2) **损失从 BCELoss 改为 evidential loss**
   - `loss = dirichlet_evidence_loss(one_hot(y), alpha, lam=anneal)`
3) **推理时同时输出概率与把握**
   - `p = alpha / sum(alpha)`
   - `uncertainty = 2 / sum(alpha)`
   - `total_evidence = sum(alpha) - 2`
4) **把证据检索对齐到“你的训练集样本体系”**
   - 同序列多构象/多实验条件时，要能追溯到具体记录（建议引入样本 ID、数据来源字段）

这样你的网站可以做到：

- 结构+序列预测（ToxGIN 主体）
- 证据：训练集/外部库的最相似实验样本 + 结构/序列对齐结果
- 建议：在保持结构骨架的约束下给出候选突变（可加上结构能量/折叠稳定性约束）

---

## 4. 产品化建议（网站层面）

建议分三层逐步上线：

1) **MVP（当前已具备）**
   - 输入序列 → 预测概率/把握 → 相似证据 → 单点改造候选
2) **研究版**
   - 支持批量输入（CSV）
   - 支持上传/提供结构（PDB）并走 ToxGIN 主干
   - 不确定性校准报告（ECE、可靠性曲线、OOD 检测）
3) **证据增强版**
   - 对接外部毒肽/AMP/DTI 数据库与文献检索
   - “证据卡片”：序列、来源、实验条件、指标、引用链接、相似度/对齐展示

