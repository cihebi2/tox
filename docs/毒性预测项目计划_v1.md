# 项目方案：轻量毒性预测（概率 + 把握 + 证据 + 改造建议）

更新时间：2026-01-15 14:13:58 +0800

本方案面向“肽毒性预测”这一老课题，在**不依赖结构预测（AlphaFold/ColabFold）**的前提下，提供一个更方便、更可部署的框架，并在输出层面同时满足：

- **概率**：`p(toxic)`
- **把握/不确定性**：模型对该概率的“证据强度/不确定性”
- **可解释性**：指出哪些残基位点贡献更大
- **证据**：给出训练集/外部库中最相似且带实验/标注结果的样本作为支撑
- **改造建议**：告诉用户“怎么改更可能降低毒性”，并给出可执行候选

当前阶段仅使用 **ToxGIN 的序列+标签数据**训练（`/root/private_data/dd_model/ToxGIN/train_sequence.csv`、`/root/private_data/dd_model/ToxGIN/test_sequence.csv`），外部数据后续逐步接入。

---

## 1. 总体架构（Predictor + Explainer + Retriever + Designer）

### 1.1 Predictor：轻量序列模型 + 不确定性输出

**输入**：肽序列（20 种标准氨基酸字母，ToxGIN 数据集中长度约 13–50）。

**轻量的定义（重要）**：这里的“轻量”并不是完全不用蛋白语言模型，而是**避免超大模型**；我们将默认采用“**一般尺寸（small/medium）的蛋白语言模型（PLM）+ 轻量适配器**”的组合，以兼顾效果与部署可行性。

**编码器（推荐组合）**：

1) **PLM residue embedding（默认启用）**  
   - 选择：ESM2 small/medium（例如 8M/35M/150M 量级）或 Ankh-base 这类可控规模模型；短肽长度较短，推理成本可控。
   - 形态：输出 per-residue embedding（`[L, d]`），作为可解释与改造的基础表征。
2) **轻量适配器（Adapter）**（参考 PROTAC-STAN 的 `ProteinEncoder` 思路）  
   - 用一到两层线性层把高维 embedding 映射到任务空间，减少后续计算量，并利于端侧/服务端部署。
3) **Pooling（可解释）**  
   - 使用 light-attention pooling 或 attention pooling 得到序列级表征；同时输出 attention 权重，作为位点解释的一个视角（注意力解释需与梯度归因交叉验证）。

> 备选 baseline（对照/资源受限）：小型 CNN/Transformer from scratch（不依赖 PLM）可作为 ablation，但主方案建议保留 PLM 分支以提升泛化与鲁棒性。

**输出头（核心创新之一）**：采用 **Evidential Deep Learning（Dirichlet）** 的分类头：

- 模型输出 Dirichlet 参数 `alpha ∈ R^{2}`（2 类：toxic / non-toxic）
- 概率：`p = alpha / sum(alpha)`
- 把握/不确定性：`uncertainty = K / sum(alpha)`（K=2）
- 证据强度：`total_evidence = sum(alpha) - K`

相比传统 Sigmoid/Softmax，该头天然支持“概率 + 把握”的联动输出，更适合做产品化决策提示与报告生成。

> 选配（第二层保险）：用 **MC Dropout** 或 **Deep Ensembles** 给出“模型不确定性”分量，用于 OOD/分布偏移时更稳健的“低把握提醒”。（轻量优先下，可先不做或只做 MC Dropout）

**特征融合（可借鉴 SCANS / PROTAC-STAN / HyperAMP）**：在“PLM 分支”之外，逐步加上可解释的辅助特征分支，提升稳定性与可解释性。

- **物化性质分支（PC features）**：逐位点的电荷/疏水性/极性等（类似 SCANS 的 PCfeas 分支），用 1D-CNN/小 Transformer 编码后与 PLM 融合。
- **motif/规则分支**：统计训练集中“高信息量的毒性相关 k-mer/motif”，并作为显式特征输入或作为后处理解释证据（参考 SCANS 的信息论 motif 列表思路）。
- **k-mer 超图分支（可选）**：参考 AMPainter 的 HyperAMP（k-mer 超边 + TF‑IDF 权重 + HGNN），在短肽 motif 组合建模上更具可解释性；可作为辅助分支或替代检索模块的一部分。

### 1.2 Explainer：残基位点权重（可用于报告与改造建议）

为了避免“只用 attention 作为解释”带来的误导，采用“双解释器”：

1) **梯度归因**：Integrated Gradients / Input×Gradient（对每个残基给贡献分数）  
2) **注意力权重**：如果编码器含注意力或 light-attention pooling，可提供更直观的权重图

输出形式：

- residue-level importance heatmap（每个位点一个分数）
- Top-K 关键位点列表（位置、残基、贡献方向/强度）
- 关键片段/motif（滑窗汇总）

补充建议（来自 PROTAC-STAN 的工程经验）：

- 在推理阶段提供 `--save_att` / `--save_explain` 类接口，把 attention map、IG attribution、motif 命中等解释文件落盘，方便后续离线分析与报告追溯。

### 1.3 Retriever：证据检索（先用训练集，后接外部库）

**目的**：为预测结论提供“可核验的证据样本”，用于网站展示与 Agent 报告引用。

阶段 1（已具备/最易落地）：

- 证据源：训练集（带 label，可视为“已验证/已标注样本”）
- 方法：char n-gram TF‑IDF 或 embedding 检索
- 输出：TopK 相似序列 + 相似度 + label（以及未来可扩展的来源字段）

阶段 2（你后续会做的外部数据接入）：

- 证据源：毒肽数据库/文献/内部实验记录库
- 输出：样本 ID、实验条件、指标、DOI/链接、摘要证据句（可自动汇总）

实现建议（参考 PROTAC-STAN 的 embedding map 缓存思路）：

- 为证据库构建离线 embedding 索引（序列 → embedding → ANN/相似度检索），并缓存成 `*_map.pkl` / `*.joblib`，避免每次在线请求重复跑 PLM。

### 1.4 Designer：改造建议（优先级与约束）

你需要“可执行”的降低毒性建议；建议按以下优先级生成候选，既易解释又更可靠：

**优先级 1：证据驱动的最小编辑（Evidence-guided minimal edits）**

- 先检索最相似的 **non-toxic** 证据序列
- 对齐两条序列，取差异位点作为候选突变
- 优点：每条建议都能回溯到“相似但不毒”的证据样本，解释性最好

**优先级 2：归因驱动的局部单点扫描（Attribution-guided scanning）**

- 选取解释器输出的 Top 位点（例如 Top 5–10）
- 对这些位点做单点替换扫描（20AA）
- 用模型批量评估，按：
  - 更低 `p(toxic)`
  - 更高把握（更低 `uncertainty` 或更高 `total_evidence`）
  - 约束满足度（见下）
  排序给 TopN

**优先级 3：生成式/优化式（后续升级项）**

- 在约束下生成多个候选序列（保持长度/净电荷/关键 motif 等）
- 需要更严格的可控与过滤机制，建议在有外部证据源后再做

**优先级 3 的具体实现路线（参考 AMPainter）**：

- **位点选择策略（Policy）**：学习“哪些位点更值得改”（可结合 Explainer 输出作为先验/初始化）。
- **替换生成器（PLM mask-and-fill）**：对选定位点打 mask，再由生成式 PLM 输出替换残基（AMPainter 用 Ankh + `<extra_id_*>` 的方式可直接借鉴）。
- **reward 设计**：以“降低毒性”为主（降低 `p_toxic`），以“高把握”为辅（惩罚高不确定性），并加入约束惩罚项（Cys 框架/电荷/疏水性等）。

**硬约束/软约束（默认建议）**

- 硬约束（默认启用）：长度不变；避免破坏关键 Cys 框架（尤其是富含 Cys 的肽）；禁止引入非标准氨基酸
- 软约束（可配置）：限制净电荷变化；限制疏水性变化；限制与原序列相似度下限

---

## 2. 训练与评估（用 ToxGIN 数据，不用结构）

### 2.1 数据与切分

- 数据：ToxGIN `train_sequence.csv` / `test_sequence.csv`（平衡二分类）
- 切分：训练集内部再划分 validation（分层采样），保留原 test 作为最终评估

### 2.2 指标（不仅看 AUROC）

基础指标：

- AUROC / AUPRC / Accuracy / F1 / MCC

“把握是否有用”的指标（建议写进论文/产品说明）：

- **校准**：ECE、可靠性曲线（预测概率是否可信）
- **选择性预测（Selectivity）**：按不确定性阈值过滤一部分样本，观察剩余样本的错误率下降（体现“把握”可用于决策）
- **OOD/分布偏移提示**：当检索证据很弱 + 不确定性高时，明确输出“需要实验验证/风险提示”

---

## 3. 面向 Agent 的输出规范（建议以 JSON 为主）

每次预测输出一个结构化对象，便于 Agent 自动生成报告：

- `input`: `sequence`, `length`, 以及基础理化（净电荷/疏水性等）
- `prediction`: `p_toxic`, `pred_label`, `uncertainty`, `total_evidence`
- `explanation`: per-residue importance、Top 位点、Top 片段
- `evidence`: TopK 相似样本（`sequence`, `label`, `similarity`, `source`(可选), `doi`(可选)）
- `design_suggestions`: 候选突变（mutation、候选序列、`p_toxic`、`uncertainty`、rationale）
- `model_metadata`: 模型版本、训练数据版本、时间戳

---

## 4. 相关工作（用于写作/对齐）

- **毒性预测**：ToxGIN（doi: 10.1093/bib/bbae583）、ToxinPred 系列（ToxinPred2: 10.1093/bib/bbac174；ToxinPred 3.0: 10.1016/j.compbiomed.2024.108926）
- **不确定性**：Evidential Deep Learning（arXiv:1806.01768）、MC Dropout（arXiv:1506.02142）、Deep Ensembles（arXiv:1612.01474）、Conformal prediction tutorial（arXiv:0706.3188）
- **可解释性**：Integrated Gradients（Axiomatic Attribution for Deep Networks, 2017）
- **可改造/融合/特征表示启发**：AMPainter（RL 位点选择 + PLM 生成 + predictor reward）、PROTAC-STAN（embedding map 缓存 + adapter + attention maps）、SCANS（小/中型 ESM2 residue embedding + 多分支融合 + motif 列表）

---

## 5. 当前落地状态（仓库内已有原型）

本仓库已实现一个 sequence-only 的可运行原型（训练 + 检索 + 改造建议 + Web 展示），可作为该方案的 MVP：

- 训练：`scripts/train_evi_tox.py`
- Web：`scripts/serve.py`、`webapp/`
- 核心模块：`toxapp/`

下一步的重点是把“解释器（位点权重）+ 约束化改造建议 + 校准评估”完善成稳定的报告产出链路，并预留外部证据源接入接口。

同时，结合你补充的三份参考项目，建议将近期迭代优先级调整为：

1) 上线“PLM（一般尺寸）+ evidential 输出 + 证据检索”的稳定版本（可部署、可复现）
2) 增加“位点解释（IG + attention）+ motif 命中解释”并固化为可下载解释文件
3) 在严格约束下引入 AMPainter 风格的闭环改造（先小规模离线实验验证 reward 与约束设计）

---

## 6. 现有数据上的快速验证（v1 数据 + 90% 相似去重 + 固定划分）

更新时间：2026-01-15 16:56:36 +0800

为验证该方案的“最小闭环”（概率 + 把握 + 证据 + 改造建议）在**当前已整理的数据**上可运行、可复现，本仓库用 v1 数据集做了一次端到端测试（注意：此处 Predictor 先用轻量 CNN baseline，PLM 版本将在下一轮对照）。

### 6.1 使用的数据与划分

- 数据版本：`data/toxicity_data_v1/`
- 输入集：`data/toxicity_data_v1/peptide_id90/dedup_id90_resolved.csv`（90% 相似去重后的代表序列，label-aware）
- 固定划分（seed=69，stratified，避免相似簇跨 split）：
  - train/val/test：`data/toxicity_data_v1/splits/peptide_id90_seed69_80_10_10/`
  - 规模（id90 reps）：
    - train 10137（0=6092，1=4045）
    - val 1267（0=761，1=506）
    - test 1268（0=762，1=506）

### 6.2 本次测试的 Predictor / Retriever / Designer

- **Predictor**：`toxapp/model.py: EvidentialToxModel`（Embedding + 多尺度 1D-CNN + Dirichlet evidential head）
  - 说明：这是“非 PLM”baseline，用于先把 evidential 输出、校准/选择性评估、端到端产物链路跑通。
- **Retriever**：`toxapp/retrieval.py`（训练集 TF‑IDF char n-gram 检索）
- **Designer（演示版）**：对少量高毒样本做“全单点突变扫描”并按 `p_toxic` 排序输出 Top 候选（未加 Cys 框架等硬约束，下一步应加）

### 6.3 结果摘要（best val AUROC 对应 checkpoint）

复现实验命令：

```bash
python scripts/test_plan_v1_current_data.py
```

产物目录：

- `artifacts/plan_test_v1_peptide_id90_seed69/summary.json`
- `artifacts/plan_test_v1_peptide_id90_seed69/test_predictions.csv`
- `artifacts/plan_test_v1_peptide_id90_seed69/retrieval.joblib`
- `artifacts/plan_test_v1_peptide_id90_seed69/design_suggestions_sample.json`

主要指标（test）：

- AUROC=0.9467，AUPRC=0.9332，ACC=0.8762，F1=0.8477，MCC=0.7438

把握/不确定性验证（test）：

- ECE=0.0590（15 bins；confidence=max(p,1-p)）
- 选择性预测（按 uncertainty 从低到高保留样本）：
  - coverage=0.5 时 ACC≈0.9779（明显高于全量 0.8762）
- 错误样本的平均 uncertainty 显著更高（correct≈0.1296 vs incorrect≈0.2380），可用于“低把握提醒/实验建议”

证据检索（test，TopK=5）：

- Top1 label 命中率≈0.8383
- Top5 多数投票命中率≈0.8470

### 6.4 结论与下一步

- 结论：在当前 v1 数据（含 90% 相似去重与固定划分）上，方案的核心输出链路已能跑通，并且“不确定性”在选择性预测上确实可用。
- 下一步（与原计划对齐）：将 Predictor 替换为“小/中型 PLM + adapter + evidential head”，并用同一 split 做对照；同时对 Designer 加入硬约束（至少默认不改 Cys 位点）与证据驱动的最小编辑策略。

---

## 7. 强化改造方法 v1：规划（先定义，再测试）

更新时间：2026-01-15 17:08:54 +0800

目标：在不引入大型生成模型的前提下，把“改造建议”从演示升级为**可评估、可复现**的离线策略，并给出“改造命中率”作为阶段性指标。  
注意：当前命中率为**模型内评估**（in-silico），用于筛选与报表指南，不等同于实验命中率。

### 7.1 约束（默认启用）

- 长度不变（仅 substitution）
- 不改 Cys 位点且不引入 Cys（from/to 均不为 C；避免破坏/引入潜在二硫键框架）
- 仅 20AA 标准字母（由 `sanitize_sequence` 保证）

### 7.2 候选生成策略（v1 将同时实现并对比）

1) **Evidence-guided neighbor edits（证据驱动最小编辑）**  
   - 证据库：train split 中 `label=0` 的序列  
   - 检索：TF‑IDF char n-gram（与 Retriever 复用）  
   - 选择：优先取“同长度”的 Top1 non-toxic neighbor（找不到则该样本此策略不可用，并统计 coverage）  
   - 候选：把原序列逐个差异位点替换成 neighbor 残基（单点替换）  
   - 优点：每条候选都可回溯到一个“相似但不毒”的证据序列，解释性强、改动最小

2) **Attribution-guided scanning（归因驱动局部扫描）**  
   - 对每条序列计算梯度显著性（saliency），选 Top‑M 位点（默认 M=8）  
   - 仅在这些位点做 19AA 单点替换扫描  
   - 优点：形成“位点权重 → 改造位点”的闭环，成本显著低于全扫描

3) **Full single-mutation scan（全单点扫描，对照上限）**  
   - 全位点 19AA 替换（在 7.1 约束下）  
   - 作为 v1 的对照上限（搜索空间最大），便于衡量“强化策略”是否有效且更省算

### 7.3 排序目标（统一）

- 主目标：最小化 `p_toxic`
- 次目标：最小化 `uncertainty`（或等价最大化 `total_evidence`）
- 输出：每条输入给 Top‑K（默认 K=5）候选，用于网页展示与 Agent 报告

### 7.4 改造“命中率”定义（Top1 / TopK）

评估对象：test split 中所有 toxic 样本（`label=1`），逐条生成候选并打分。

- **Flip hit**：Top‑K 中存在候选满足 `p_toxic < 0.5`
- **Reduce hit**：Top‑K 中存在候选满足 `p_toxic <= p_base - Δ`（默认 Δ=0.2）

不确定性约束（同时报告两版，便于产品策略选择）：

- strict：候选需满足 `uncertainty <= unc_base + ε`，默认 `ε=0.0`
- relaxed：`ε=0.05`

补充统计（用于报表）：Top‑1 的平均 `Δp_toxic`、平均 `Δuncertainty`、以及候选数量与策略 coverage。

### 7.5 评估协议（避免证据泄漏）

- Predictor：加载 checkpoint `artifacts/plan_test_v1_peptide_id90_seed69/evi_tox.pt`
- Evidence/Retrieval：仅使用 train split 构建（`data/toxicity_data_v1/splits/peptide_id90_seed69_80_10_10/peptide_id90_train.csv`）
- 评估集：`data/toxicity_data_v1/splits/peptide_id90_seed69_80_10_10/peptide_id90_test.csv` 中 `label=1` 子集
- 产物：`artifacts/design_eval_v1_peptide_id90_seed69/` 下输出 `summary.json`、`per_case.csv`、若干样例文件（可直接供网页/Agent 使用）

复现实验命令（将新增脚本）：  

```bash
python scripts/evaluate_design_hit_rate_v1.py
```

结果（命中率/样例）将在脚本执行后补充。

### 7.6 v1 执行结果（当前 baseline 上的“改造命中率”）

更新时间：2026-01-15 17:15:40 +0800

复现命令：

```bash
python scripts/evaluate_design_hit_rate_v1.py
```

产物目录：

- `artifacts/design_eval_v1_peptide_id90_seed69/summary.json`
- `artifacts/design_eval_v1_peptide_id90_seed69/per_case.csv`
- `artifacts/design_eval_v1_peptide_id90_seed69/samples_top10.json`

设置（v1 默认）：

- 评估集：test 中 `label=1` 共 **506** 条；其中模型预测为 toxic（`p_toxic>=0.5`）的子集 **437** 条
- 约束：仅单点 substitution；不改/不引入 Cys
- 策略参数：Attribution Top‑M=8；Evidence 检索 TopK=80 且要求同长度；输出 Top‑K=5；Δ=0.2；ε∈{0.0, 0.05}
- 排序：先 `p_toxic` 后 `uncertainty`（因此在“阈值类命中率”上，Top‑1 与 Top‑K 等价）

结果（命中率为 in‑silico，满足不确定性约束）：

**A) 全部 test label=1（n=506）**

| Strategy | coverage | cand_mean | Flip hit (ε=0.0) | Flip hit (ε=0.05) | Reduce hit (ε=0.0) | Reduce hit (ε=0.05) | Top1 Δp_mean | Top1 Δunc_mean |
| --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: | ---: |
| Evidence edits | 0.741 | 17.3 | 0.154 | 0.168 | 0.069 | 0.081 | 0.119 | 0.020 |
| Attribution scan | 1.000 | 111.5 | 0.253 | 0.269 | 0.146 | 0.162 | 0.208 | 0.022 |
| Full scan | 1.000 | 360.5 | 0.257 | 0.277 | 0.150 | 0.170 | 0.220 | 0.024 |

**B) 仅统计“模型当前也判为 toxic”的子集（n=437，更贴近产品触发改造场景）**

| Strategy | coverage | cand_mean | Flip hit (ε=0.0) | Flip hit (ε=0.05) | Top1 Δp_mean | Top1 Δunc_mean |
| --- | ---: | ---: | ---: | ---: | ---: | ---: |
| Evidence edits | 0.735 | 17.0 | 0.060 | 0.073 | 0.127 | 0.037 |
| Attribution scan | 1.000 | 107.6 | 0.135 | 0.153 | 0.224 | 0.043 |
| Full scan | 1.000 | 353.8 | 0.140 | 0.163 | 0.238 | 0.046 |

观察与结论（对 v1 的启示）：

- Attribution‑guided scanning 的命中率接近 full scan，但候选数量约 **3× 更少**，更符合“轻量可部署 + 可解释”的目标。
- Evidence edits 的命中率略低且 coverage 受“同长度”限制，但每条候选都有明确证据序列支撑，适合作为网页默认的“可解释、最小改动”建议；失败时再 fallback 到 Attribution/Full scan。
- 单点替换对“高置信 toxic”样本的翻转仍有上限；若要显著提升命中率，下一步应加入**多步改造（2–3 步 greedy/beam search）**与更丰富的约束/奖励（例如电荷/疏水性变化上限 + 不确定性惩罚）。

### 7.7 结果解读（科研视角，用于判断“改造模块”效果边界）

更新时间：2026-01-15 21:18:44 +0800

适用范围说明：本节结果来自短肽数据 `peptide_id90` + 当前 CNN evidential baseline 的 in‑silico 评估；若科研任务是“蛋白全长毒性预测”，需要在 protein 数据上复现同一评估流程后再下结论。

关键判断：v1 的“单点改造”模块**对边界样本很有效**，但对 `p_toxic` 极高的样本（本次占比很大）存在显著上限。

**(1) 命中率强依赖 base `p_toxic`（以更贴近触发场景的子集 n=437 为例）**

- 分布：`p_toxic∈[0.9,1.0]` 的样本数为 **381/437**（≈87%），因此总体 hit rate 主要由这部分决定。
- Attribution / Full scan 在不同区间的 Flip hit（ε=0.0，Top‑1）：
  - `p_toxic∈[0.5,0.8]`：Flip=**1.000**（但 n=18，很少）
  - `p_toxic∈[0.8,0.9]`：Flip≈**0.737–0.789**（n=38）
  - `p_toxic∈[0.9,1.0]`：Flip≈**0.034**（n=381，主导总体）
- Evidence edits 在 `p_toxic∈[0.9,1.0]` 上 Flip=**0.000**，且 Top‑1 平均降幅 `Δp` 仅 **0.044**，说明“证据驱动的最小改动”对强毒序列很难靠单点扭转。

**(2) Evidence edits 的有效性受检索质量与约束影响**

- 由于要求“同长度 non‑toxic 邻居”，coverage≈0.735；对无同长度证据的样本会直接失效。
- TF‑IDF 相似度与 Flip hit 的相关性很弱（corr≈0.083），且大多数证据相似度 ≤0.1，提示：仅靠 char n‑gram 检索很难在强毒区域找到“足够近的非毒邻居”。

**(3) 如何评价：当前结果“够不够好”**

- 作为科研原型：已经证明“位点显著性 → 变体筛选 → 概率/不确定性联动输出”的闭环可运行，并且 Attribution‑guided 的性价比接近 full scan（候选更少、可解释性更强）。
- 作为“强毒序列改造”方法：单点替换在高置信区间（`p_toxic>0.9`）翻转率仅 ~3.4%，需要把 v2 升级为**多步改造（2–3 步）**与更强的约束/奖励设计，才能显著提高 hit rate。
- 方法学风险：当前命中率由同一个 predictor 评分得到，存在“骗过模型”的可能；科研上建议增加独立模型/外部预测器/集成模型作为复核或二次筛选（避免 reward hacking）。

---

## 8. 蛋白毒性（protein）版本：实验计划 v1（时间外推 + 不平衡 + Focal/BACC/PR）

更新时间：2026-01-15 21:58:11 +0800

目标：把现有“概率 + 把握（不确定性）”框架扩展到 **protein-level 毒性二分类**，并严格按最新工作常用的 **时间外推评估** 与 **极端不平衡评估** 规范来做，形成可复现的基线与后续可扩展接口（多端点、多任务）。

### 8.1 任务定义与输出

- 输入：蛋白质一级序列（20AA；长度可达 3k+）
- 输出（单端点，v1）：`p_toxic`、`pred_label`、`uncertainty/total_evidence`  
- 评估重点：在 **post‑year（time OOD）** 与极端不平衡场景下，概率是否可用（PR/BACC/校准）与不确定性是否能提示风险。

### 8.2 数据与时间划分（ToxDL2，本仓库已落盘）

- 数据版本：`data/toxicity_data_v1/protein/dedup_resolved.csv`（ToxDL2 来源，去重后 22339 条）
- 原始时间外推 split（来自 ToxDL2）：  
  - `toxdl2_train`：14700（0=9800，1=4900）  
  - `toxdl2_valid`：931（0=853，1=78）  
  - `toxdl2_test`：1847（0=1735，1=112）  
  - `toxdl2_independent`：4862（0=4710，1=152，论文语境为 post‑2022 外部独立集）
- 去泄漏注意：去重后仍存在极少数跨 split 重复（目前统计为 1 条）；v1 将在本仓库内重新落盘“无重叠 time split”，并约定优先级 `independent > test > valid > train`。

### 8.3 模型与对照（轻量可部署优先）

v1 先跑通流程并建立基线，再上 PLM：

1) **Baseline‑A（先跑通）**：`toxapp/model.py:EvidentialToxModel`（多尺度 CNN + evidential head）  
   - 优点：不依赖外部权重，能直接处理长序列；适合先验证 time split/不平衡指标/不确定性输出链路。

2) **Target‑B（protein 主力版本）**：小/中型 PLM + adapter + evidential head  
   - 选择：ESM2 small/medium（如 35M/150M 量级）  
   - 策略：默认冻结 PLM（省显存/更易部署），仅训练 adapter+head；可选解冻最后 1–2 层做对照  
   - 长序列：设置 `max_len`（如 1024/1536），对超长序列采用截断或滑窗 pooling（需在 Methods 明确，并做消融）

### 8.4 不平衡训练策略（Focal loss + 类权重）

极端不平衡主要体现在 `test/independent`（约 1:15 与 1:31）。v1 训练端计划：

- 在 evidential loss 上加入 **类权重**（按 train 频率反比）  
- 加入 **focal weighting**：`w = (1 - p_true) ^ gamma`，默认 `gamma=2`  
- 仍保留 KL warmup（避免早期过强正则导致证据塌缩）

> 对照：BCE/Weighted BCE（无 evidential）与 focal CE 可作为 ablation，验证“evidential + focal/weighting”的收益与代价。

### 8.5 指标与阈值（BACC / PR 为主）

在 time OOD + 不平衡场景下，v1 报告以下指标：

- 概率排序：AUROC、**AUPRC（PR）**
- 阈值相关：**BACC**、MCC、F1、Sensitivity/Specificity、Precision/Recall
- 阈值选择：在 `valid` 上做阈值扫描（F‑max 或 MCC‑max），再固定阈值评估 `test` 与 `independent`；同时保留 0.5 阈值结果作对照。

### 8.6 可复现产物与脚本（将落盘）

- time split 生成：`scripts/split_toxdl2_protein_time_v1.py` → `data/toxicity_data_v1/splits/protein_toxdl2_time_v1/`
- 训练/评估：`scripts/test_protein_plan_v1_toxdl2.py` → `artifacts/protein_plan_test_v1_toxdl2/`
- 产物最小集合：`summary.json`、`val_threshold.json`、`test_predictions.csv`、`independent_predictions.csv`、`run_manifest.json`

### 8.7 立即执行（本次会先跑通 Baseline‑A）

- 先生成无重叠的 ToxDL2 time split CSV（train/val/test/independent）
- 训练 evidential CNN baseline（加入 focal/class weighting），在 test 与 independent 上评估 BACC/AUPRC/MCC，并把结果回写到本计划文档

### 8.8 v1 执行结果（Baseline‑A：序列 CNN + evidential + focal/class weighting）

更新时间：2026-01-15 22:24:56 +0800

复现命令：

```bash
python scripts/split_toxdl2_protein_time_v1.py
python scripts/test_protein_plan_v1_toxdl2.py
```

time split（已去除跨 split 重复；优先级 independent > test > val > train）：

- 输出目录：`data/toxicity_data_v1/splits/protein_toxdl2_time_v1/`
- 计数：train 14700（0=9800，1=4900）/ val 931（0=853，1=78）/ test 1846（0=1734，1=112）/ independent 4862（0=4710，1=152）

训练设置（关键项）：

- 模型：`toxapp/model.py:EvidentialToxModel`（多尺度 CNN + Dirichlet evidential head）
- loss：`dirichlet_evidence_loss` + class_weights（train 频率反比）+ focal（gamma=2.0）+ KL warmup
- 最佳 epoch：5（early stopping；val 选择指标：MCC；阈值来自 val 扫描）
- 产物目录：`artifacts/protein_plan_test_v1_toxdl2/summary.json`、`artifacts/protein_plan_test_v1_toxdl2/test_predictions.csv`、`artifacts/protein_plan_test_v1_toxdl2/independent_predictions.csv`

结果摘要（best threshold = 0.4975；ranking 指标与阈值指标分开汇报）：

| split | AUROC | AUPRC(PR) | BACC | MCC | F1 | Precision | Recall |
| --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: |
| val | 0.9403 | 0.7065 | 0.8187 | 0.6930 | 0.7133 | 0.7846 | 0.6538 |
| test (pre‑year) | 0.9482 | 0.6700 | 0.7943 | 0.6209 | 0.6415 | 0.6800 | 0.6071 |
| independent (post‑year) | 0.8782 | 0.3472 | 0.7166 | 0.3805 | 0.3989 | 0.3518 | 0.4605 |

解读要点（科研视角）：

- 时间外推集（independent）AUPRC 明显下降是预期现象，但依然显著高于其阳性比例基线（152/4862≈0.031）；说明模型对 post‑year OOD 仍保留一定排序能力（AUROC≈0.878）。
- 后续要进一步提升 independent 的 PR/BACC，优先级建议：上 small/medium PLM（冻结 + adapter）对照 Baseline‑A → 再做阈值/校准（temperature/conformal）与更严格同源去重（如 CD‑HIT 0.8 评估）。

### 8.9 PLM 分支 v1（ESM2‑t12‑35M，先冻结 + adapter）：计划与对照协议

更新时间：2026-01-15 23:03:23 +0800

目标：在保持“轻量可部署”的前提下，引入蛋白质语言模型（PLM）表征，验证其对 **time OOD（independent）** 的 PR/BACC 提升幅度，并把 PLM 的表征能力用于：预测（更强泛化）+ 证据检索（embedding 相似度）。

**本次试用 PLM（本地路径）**

- `PLM_PATH=/root/group_data/qiuleyu/esm2_t12_35M_UR50D`（HF 格式：`config.json`/`model.safetensors`/`vocab.txt`）

**特征表示（PLM 分支）**

- tokenizer：EsmTokenizer（20AA 字符级 token）
- encoder：ESM2‑t12‑35M 输出 `last_hidden_state`（hidden_size=480）
- pooling：对 residue tokens 做 mean pooling（排除 `<cls>/<eos>/<pad>`）
- 长序列：ESM2 `max_position_embeddings=1026`，对长度>1024 采用滑窗分块（chunk_size=1024，stride 可配置），再对 chunk embedding 做 mean 聚合为序列级向量
- head：`MLP(adapter)->Dirichlet evidential head`（输出 `p_toxic` + `uncertainty/total_evidence`）

**训练策略（轻量优先）**

- 默认冻结 PLM（`requires_grad=False`），仅训练 adapter+head（可选解冻最后 1 层做对照）
- 不平衡：沿用 v1 的 class_weights + focal weighting（gamma=2.0）与 KL warmup

**对照协议（与 Baseline‑A 完全一致）**

- time split：`data/toxicity_data_v1/splits/protein_toxdl2_time_v1/`（train/val/test/independent）
- 指标：AUROC、AUPRC(PR)、BACC、MCC、F1、Precision/Recall（阈值在 val 上扫描选定，再固定评估 test/independent）
- 产物：`artifacts/protein_plan_test_v1_toxdl2_plm/summary.json` + 预测 CSV；同时保存 train embedding 检索索引（cosine）

**复现实验命令（将新增脚本）**

```bash
python scripts/test_protein_plan_v1_toxdl2_plm.py --plm-path /root/group_data/qiuleyu/esm2_t12_35M_UR50D
```

结果（对照表）将在脚本执行后补充。

### 8.10 PLM 分支 v1：执行结果（ESM2‑35M frozen + adapter + evidential）

更新时间：2026-01-15 23:53:49 +0800

复现命令：

```bash
python scripts/test_protein_plan_v1_toxdl2_plm.py --plm-path /root/group_data/qiuleyu/esm2_t12_35M_UR50D
```

产物目录：

- `artifacts/protein_plan_test_v1_toxdl2_plm/summary.json`
- `artifacts/protein_plan_test_v1_toxdl2_plm/test_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm/independent_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm/retrieval_tfidf.joblib`
- `artifacts/protein_plan_test_v1_toxdl2_plm/retrieval_plm.joblib`（train pooled embedding 的 cosine 检索索引）

设置摘要（PLM 表征）：

- 模型：ESM2‑t12‑35M（hidden=480），冻结 PLM，仅训练 `MLP(adapter=256)+evidential head`
- pooling：residue mean（排除 `<cls>/<eos>/<pad>`）
- 长序列：chunk_size=1024，stride=512，chunk 向量按长度加权平均成序列向量
- best epoch：7；best threshold=0.4984（在 val 上按 MCC 扫描选择）

结果摘要（ranking + 不平衡阈值指标）：

| split | AUROC | AUPRC(PR) | BACC | MCC | F1 | Precision | Recall |
| --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: |
| val | 0.9774 | 0.8330 | 0.8927 | 0.7678 | 0.7875 | 0.7683 | 0.8077 |
| test (pre‑year) | 0.9868 | 0.8186 | 0.8679 | 0.6992 | 0.7173 | 0.6800 | 0.7589 |
| independent (post‑year) | 0.9508 | 0.4200 | 0.8429 | 0.5056 | 0.5000 | 0.3819 | 0.7237 |

与 Baseline‑A（8.8）对照（更关注 time OOD 的 PR/BACC）：

- test：AUPRC `0.6700 → 0.8186`；BACC `0.7943 → 0.8679`
- independent：AUPRC `0.3472 → 0.4200`；BACC `0.7166 → 0.8429`

结论（v1）：

- 在不引入结构信息的前提下，小型 PLM（35M）对 protein 毒性预测的 time OOD 泛化（independent）带来显著增益，且可以直接把 pooled embedding 用于“证据检索”（`retrieval_plm.joblib`）以增强可解释性/可追溯性。

### 8.11 PLM‑contact pseudo‑structure 图分支 v1：规划与评估协议（不依赖外部结构库）

更新时间：2026-01-16 08:02:31 +0800

目标：在不使用 PDB/AlphaFoldDB/模板结构的情况下，从 PLM 内部信号构造“伪结构（pseudo‑structure）”并形成 **图分支**，提升对长程依赖/跨段相互作用的建模能力，并在 time OOD（independent）上验证增益。

#### 8.11.1 核心思路：用 ESM2 注意力近似 residue‑residue contact

- 输入：序列（可能 >1024 aa）
- 从 ESM2 提取：
  - residue embedding：`H ∈ R^{L×d}`（d=480）
  - last-layer attention：`A ∈ R^{h×T×T}`（h=20；T=L+2 含 `<cls>/<eos>`）
- 构造 pseudo-contact 得分矩阵 `C ∈ R^{L×L}`：
  - `C = mean_heads(A)[1:-1, 1:-1]`
  - 对称化：`C = (C + C^T) / 2`
  - 可选 APC（average product correction）：提升对比度，减弱背景相关

> 说明：这里的 contact 不是“真实 3D 接触”，而是 PLM 的注意力诱导的近似图结构；优势是完全不需要结构预测，且能捕获跨远距离的依赖信号。

#### 8.11.2 图构建与编码（轻量 GNN）

- 图构建：对每个 residue i，取 `C[i,:]` 的 top‑k 邻居（默认 k=32），形成稀疏无向图（双向边+自环）
- 节点特征：使用 residue embedding `H`
- 图编码器（轻量）：
  - 2‑layer mean-aggregation GNN（GraphSAGE/GCN 的简化版），hidden=256
  - 图级 pooling：mean pooling 得到 `g ∈ R^{256}`

#### 8.11.3 融合与输出（保持 evidential）

- 序列向量：`s = mean_pool(H) ∈ R^{480}`
- 图向量：`g ∈ R^{256}`
- 融合：`z = concat([s, g]) ∈ R^{736}` → `MLP(adapter)` → Dirichlet evidential head
- 输出：`p_toxic + uncertainty/total_evidence`

#### 8.11.4 训练/评估协议（对照一致）

- 数据与 time split：`data/toxicity_data_v1/splits/protein_toxdl2_time_v1/`
- 不平衡：class_weights + focal(gamma=2.0) + KL warmup（与 8.8/8.10 一致）
- 阈值：在 val 上按 MCC（或 BACC）扫描选阈值，固定评估 test/independent
- 对照组：
  - Baseline‑A（8.8）：CNN evidential（无 PLM）
  - PLM‑mean（8.10）：ESM2 pooled embedding（无图分支）
  - **PLM‑contact‑graph（本节）**：ESM2 + pseudo-contact graph + GNN

#### 8.11.5 预期产物

- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/summary.json`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/test_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/independent_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/retrieval_plm_contact.joblib`（可选：用融合向量建 train 证据检索索引）

复现命令（将新增脚本）：

```bash
python scripts/test_protein_plan_v1_toxdl2_plm_contact.py --plm-path /root/group_data/qiuleyu/esm2_t12_35M_UR50D
```

#### 8.11.6 执行结果（v1）

更新时间：2026-01-16 09:52:57 +0800

产物目录：

- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/summary.json`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/test_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/independent_predictions.csv`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/retrieval_tfidf.joblib`
- `artifacts/protein_plan_test_v1_toxdl2_plm_contact/retrieval_plm_contact.joblib`

设置摘要（PLM‑contact 图分支）：

- PLM：ESM2‑t12‑35M（hidden=480），冻结；attention 实现：`eager`
- pseudo‑contact：last‑layer attention（mean heads）→ 对称化 → APC（开启）→ row‑wise top‑k（k=32）建图
- 图编码：2‑layer mean aggregation GNN（hidden=256），训练；融合：`[seq_mean(480) ; graph(256)]` → evidential head
- 长序列：chunk_size=1024，stride=512，chunk 融合按长度加权平均
- best epoch：3；best threshold=0.5578（在 val 上按 MCC 扫描选择）

结果摘要（ranking + 不平衡阈值指标；阈值=val‑best）：

| split | AUROC | AUPRC(PR) | BACC | MCC | F1 | Precision | Recall |
| --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: |
| val | 0.9653 | 0.8704 | 0.9090 | 0.8181 | 0.8333 | 0.8333 | 0.8333 |
| test (pre‑year) | 0.9854 | 0.8295 | 0.9255 | 0.8147 | 0.8255 | 0.7886 | 0.8661 |
| independent (post‑year) | 0.9656 | 0.4779 | 0.8640 | 0.5736 | 0.5721 | 0.4600 | 0.7566 |

与 PLM‑mean（8.10）对照（更关注 time OOD 的 PR/BACC）：

- test：AUPRC `0.8186 → 0.8295`；BACC `0.8679 → 0.9255`
- independent：AUPRC `0.4200 → 0.4779`；BACC `0.8429 → 0.8640`

结论（v1）：

- 在不引入外部结构/不做结构预测的前提下，“attention‑诱导 pseudo‑contact 图分支”在 protein 的 time OOD（independent）上继续带来增益；同时保留 evidential 输出（概率 + 不确定性）与 embedding 检索索引（`retrieval_plm_contact.joblib`），可作为后续“证据 + 改造建议”Agent 的特征底座。
